<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>تطبيق البحث في ملف TXT</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css">
  <style>
    /* نفس النمط السابق بدون تغيير */
  </style>
</head>
<body>
  <header>تطبيق البحث في ملف TXT</header>
  <div class="container">
    <div class="section upload-section" id="uploadSection">
      <input type="file" id="fileInput" accept=".txt">
    </div>
    <div class="section search-section hidden" id="searchSection">
      <div class="back-button" id="backButton">&#8592; رجوع</div>
      <input type="text" id="searchBox" placeholder="اكتب نص البحث">
      <button id="searchBtn">بحث</button>
      <div id="progressContainer">
        <div id="progressBar"></div>
      </div>
      <div class="results" id="results"></div>
    </div>
  </div>
  <script>
    let file, chunkSize = 1024 * 1024, offset = 0, remainder = "", query = "";
    const displayDelay = 200; 
    let delayIndex = 0;
    let currentSearchType = "query";
    let currentField2Value = "";
    let displayedNames = new Set();
    let stopMainSearch = false;
    let timeouts = [];
    
    const columnLabels = [
      "رقم التسجيل",    
      "رقم التومينية",  
      "الاسم الأول",    
      "اسم الأب",       
      "اسم الجد",       
      "الرقم التسلسلي", 
      "تاريخ الميلاد",  
      "المهنة",         
      "اسم الأم",       
      "اسم الجدة",      
      "القضاء",         
      "الناحية",        
      "الشارع",         
      "رقم الدار",      
      "المنطقة"         
    ];
    
    const fileInput = document.getElementById("fileInput");
    const uploadSection = document.getElementById("uploadSection");
    const searchSection = document.getElementById("searchSection");
    const backButton = document.getElementById("backButton");
    const searchBtn = document.getElementById("searchBtn");
    const progressBar = document.getElementById("progressBar");
    const resultsContainer = document.getElementById("results");
    const searchBox = document.getElementById("searchBox");
    
    fileInput.addEventListener("change", function(e) {
      file = e.target.files[0];
      if (!file) return;
      offset = 0;
      remainder = "";
      uploadSection.classList.add("hidden");
      searchSection.classList.remove("hidden");
      currentSearchType = "query";
      displayedNames.clear();
      stopMainSearch = false;
    });
    
    backButton.addEventListener("click", function() {
      fileInput.value = "";
      file = null;
      offset = 0;
      remainder = "";
      query = "";
      searchBox.value = "";
      progressBar.style.width = "0%";
      resultsContainer.innerHTML = "";
      searchSection.classList.add("hidden");
      uploadSection.classList.remove("hidden");
      currentSearchType = "query";
      displayedNames.clear();
      stopMainSearch = false;
    });
    
    searchBtn.addEventListener("click", function() {
      query = searchBox.value.trim();
      if(query === "") {
        alert("يرجى إدخال نص للبحث");
        return;
      }
      resultsContainer.innerHTML = "";
      progressBar.style.width = "0%";
      offset = 0;
      remainder = "";
      delayIndex = 0;
      displayedNames.clear();
      currentSearchType = "query";
      stopMainSearch = false;
      processChunk();
    });
    
    function processChunk() {
      if(stopMainSearch) return;
      if(offset >= file.size) {
        if(remainder) processText(remainder);
        progressBar.style.width = "100%";
        return;
      }
      const slice = file.slice(offset, offset + chunkSize);
      const reader = new FileReader();
      reader.onload = function(e) {
        if(stopMainSearch) return;
        let text = remainder + e.target.result;
        let lines = text.split("\n");
        remainder = lines.pop();
        processText(lines.join("\n"));
        offset += chunkSize;
        progressBar.style.width = Math.floor((offset / file.size) * 100) + "%";
        setTimeout(processChunk, 0);
      };
      reader.readAsText(slice);
    }
    
    function processText(text) {
      if(stopMainSearch) return;
      let lines = text.split("\n");
      const queryWords = query.split(/\s+/);
      lines.forEach(line => {
        if(stopMainSearch) return;
        let fields = line.trim().split(/\s+/);
        if(fields.length >= (2 + queryWords.length)) {
          let isMatch = true;
          for(let i = 0; i < queryWords.length; i++){
            if(!fields[2 + i] || !fields[2 + i].includes(queryWords[i])){
              isMatch = false;
              break;
            }
          }
          if(isMatch) {
            const personName = (fields[2] || "") + " " + (fields[3] || "") + " " + (fields[4] || "");
            if(displayedNames.has(personName)) return;
            displayedNames.add(personName);
    
            let copyText = "";
            let html = "";
    
            html += "<span>" + columnLabels[1] + ": " + (fields[1] || "") + "</span>";
            html += "<span>الاسم: " + personName + "</span>";
            html += "<span>" + columnLabels[5] + ": " + (fields[5] || "") + "</span>";
            if(fields[8]) {
              html += "<span>" + columnLabels[8] + ": " + fields[8] + "</span>";
            }
            for(let i = 0; i < fields.length; i++){
              let label = (i < columnLabels.length) ? columnLabels[i] : ("عمود " + (i+1));
              copyText += label + ": " + fields[i].trim() + "\n";
            }
            const div = document.createElement("div");
            div.className = "result-item";
            const btnContainer = "<div class='btn-container'>" +
              "<button class='family-btn' onclick='event.stopPropagation(); timeouts.forEach(clearTimeout); stopMainSearch=true; resultsContainer.innerHTML=\"\"; searchByField2(\"" + fields[1] + "\")'><i class='fas fa-users'></i> عرض العائلة</button>" +
              "<button class='copy-btn' data-copy='" + copyText.replace(/'/g, "&#39;") + "' onclick='event.stopPropagation(); copyText(this)'><i class='fas fa-copy'></i> نسخ</button>" +
              "</div>";
            div.innerHTML = html + btnContainer;
            const timeoutId = setTimeout(() => {
              resultsContainer.appendChild(div);
            }, displayDelay * delayIndex++);
            timeouts.push(timeoutId);
          }
        }
      });
    }
    
    function copyText(el) {
      const text = el.getAttribute("data-copy");
      navigator.clipboard.writeText(text).then(() => {
        el.textContent = "تم النسخ";
        setTimeout(() => {
          el.innerHTML = "<i class='fas fa-copy'></i> نسخ";
        }, 2000);
      });
    }
    
    function searchByField2(field2Value) {
      timeouts.forEach(clearTimeout);
      timeouts = [];
      resultsContainer.innerHTML = "";
      offset = 0;
      remainder = "";
      delayIndex = 0;
      progressBar.style.width = "0%";
      displayedNames.clear();
      currentSearchType = "field2";
      currentField2Value = field2Value;
      processChunkField2();
    }
    
    function processChunkField2() {
      if(offset >= file.size) {
        if(remainder) processTextField2(remainder);
        progressBar.style.width = "100%";
        return;
      }
      const slice = file.slice(offset, offset + chunkSize);
      const reader = new FileReader();
      reader.onload = function(e) {
        let text = remainder + e.target.result;
        let lines = text.split("\n");
        remainder = lines.pop();
        processTextField2(lines.join("\n"));
        offset += chunkSize;
        progressBar.style.width = Math.floor((offset / file.size) * 100) + "%";
        setTimeout(processChunkField2, 0);
      };
      reader.readAsText(slice);
    }
    
    function processTextField2(text) {
      let lines = text.split("\n");
      lines.forEach(line => {
        let fields = line.trim().split(/\s+/);
        if(fields[1] && fields[1].trim() === currentField2Value) {
          let html = "";
          let copyText = "";
          html += "<span>" + columnLabels[5] + ": " + (fields[5] || "") + "</span>";
          for(let i = 0; i < fields.length; i++){
            let label = (i < columnLabels.length) ? columnLabels[i] : ("عمود " + (i+1));
            html += "<span>" + label + ": " + fields[i].trim() + "</span>";
            copyText += label + ": " + fields[i].trim() + "\n";
          }
          const div = document.createElement("div");
          div.className = "result-item";
          const btnContainer = "<div class='btn-container'>" +
            "<button class='copy-btn' data-copy='" + copyText.replace(/'/g, "&#39;") + "' onclick='event.stopPropagation(); copyText(this)'><i class='fas fa-copy'></i> نسخ</button>" +
            "</div>";
          div.innerHTML = html + btnContainer;
          const timeoutId = setTimeout(() => {
            resultsContainer.appendChild(div);
          }, displayDelay * delayIndex++);
          timeouts.push(timeoutId);
        }
      });
    }
  </script>
</body>
</html>
